# Пример разработки System Design для B2C рассылки клиентам

### Проблематика

Сформулируйте вопросы, которые позволят собрать функциональные и нефункциональные требования для решения задачи ниже (без их описания). 

Предложите любой вариант реализации такого решения.

Это обязательный вопрос *(Взято из реального теста на должность архитекора)*

### Заданиие
Есть B2C продукт, для регистрации используется email. 

Есть желание использовать дополнительные email-рассылки для повышения конверсии в продукте, снижения churn. Планируется задать на разные состояния пользователя (статус платности, количество дней с регистрации, факт (не)использования продуктовых фич) персонализированный контент, а затем отправлять письма.

В пользовательском соглашении нет пункта, который разрешает делать email-рассылки. 

Нужно составить список вопросов, которые стоит задать коллегам (marketing, developers, devops, etc) перед проектированием решения.

Ожидаемый результат: 
~~ссылка на GoogleDoc, в котором перечислены вопросы, а также вариант решения для такой задачи~~

---

## Предлагаемое решение

Естественно, это всего лишь тестовове задание, ограниченное по времени (примерно 2 часа)

### Первоначальные вопросы для сбора требований. 

Предположим, что на вопросы уже получены ответы.

Глоссарий: разрабатываемая система: System under Development - SuD 

### Вопросы к маркетингу и product owners (Marketing)
№ | Вопрос  | Ответ
--| ------------- | -------------
1 | Скольким пользователям необходимо рассылать письма  | Все, которые есть в базе. Сейчас 100.000 пользователей
2 | Какой масштаб рассылок планируется через 3 месяца, полгода, год  | Увеличение в два раза каждый период
3 | SuD должна быть интегрирована в существующую или это независимая система | Должна быть интегрирована по HTTP API
4 | Письма отправляются на основной email пользователя или он может указать дополнительный, именно для рассылок	| На основной, дополнительный не предполагаемся в силу отсутсвия пункта в соглашении по рассылкам
5 | Пользователь может отписаться от получения рассылок | Да
6 | Письма отправляются в plain/text или как html со встроенным/внешним контентом | В HTML со встроенным контентом
7 | Система реального времени или мягкого. Какая минимальная задержка между формированием письма и отправкой его клиенту | Мягкого реального времени. Письма надо отправлять можно быстрее, не более 1 минуты
8 | Какой максимальный размер письма для отправки клиенту | 2 МБ со встроенным контентом
9 | Есть ли расписание или график, по которому необходимо отправлять письма клиентам, согласно их состояниям | Для каждого состояния типа пользователя свой график отправки
10 | Надо ли сохранять отправленные письма клиентам в хранилище системы и на какой срок | Да, надо. Срок хранения 30 календарных дней
11 | Письма формируется по шаблону или менеджер формирует письма через административный интерфейс | Письма формируются по шаблону, который можно изменять менеджеру
12 | Кто инициирует формирование письма клиенту | Система по достижения бизнес-правила статуса или менеджер вручную

### Вопросы к команде разработки (Developers)

№ | Вопрос  | Ответ
--| ------------- | -------------
1 | Какие существующие сервисы можно применить для упрощения архитектуры | Есть рассыльщик писем
2 | Используются ли внешние рассыльщики писем и если да, какие способы интеграции и есть ли подпись для защиты от спама | Да. Он подтвержден как безопасный. Интеграция по HTTP API
3 | Переход со статуса на статус порождает ли какие-нибудь события	 | Да
4 | Возможно ли из существующей Системы делать POST запросы | Да

### Вопросы к DevOps

№ | Вопрос  | Ответ
--| ------------- | -------------
1 | Как выглядит основной технологический стек | Nginx, PostgreSQL, Kafka, PHP/Go/Python/C#
2 | На какой платформе развернута система (cloud-native, vm, etc) | Self-Hosted, Cloud-native
3 | Используется ли подход CI/CD/CD | Используется, только без Continius Deployment

### Вопросы к CTO/Architect

№ | Вопрос  | Ответ
--| ------------- | -------------
1 | Возможны ли изменения в стеке проекта | Да. На усмотрение архитектора
2 | Какой подход преобладает в архитектуре | Монолитная (Legacy-AS-IS) и микросервисная (To-Be)
3 | Используются ли ADR для управления архитектурой | Нет, но можно внедрить

## Разработка 

Необходима реализация следующих User Stories


№ | User Story 
--| ------------- 
US1 | Я, как менеджер, могу  через SuD заводит шаблоны для каждого типа статуса клиента
US2 | Я, как менеджер, могу  через SuD заводит персонализированный контент для каждого типа статуса клиента
US3 | Я, как менеджер, могу вручную через SuD инициировать рассылку сообщений
US4 | Я, как менеджер, могу через SuD просмотреть статусы отправки сообщений

### Вариант решения

Так как система должна быть масштабируема и устойчива к сбоям внешнего контура (рассыльщик) был выбран Event-driven подход c микросервисной архитектурой.

На каждое состояние пользователя создается топик. 

Масштабируемость достигается увеличением кол-ва партиций в конкретном топике.

Шаблоны для каждого состояния пользователя и для контента задаются через систему управления шаблонами.

Так же, каждый µ-сервис шаблонизации подписывается на свой топик и обрабатывает только те события, которые есть в нем.

Для обратной связи сервисов с менеджером используется reply-bus

Предлагаемый стек:
* Debezium
* PostgreSQL
* Kafka
* Kafka Connect

Структуры данных:

```
Событие из системы в рассыльщик (msg)
{
Тип сообщения(1-рассылка, 2-персонализированный контент)
email
данные о пользователе
ID-шаблона
Текст сообщения или ID-контента
}
```

**Элементы SuD**

* Smart Sender - сервис сохранения email, сообщения и ID-шаблона
* Шаблонизатор - формирования письма согласно ID-шаблона и контента
* OutBox - логиеский элемент из Debezium, KafkaConnect
* Circuit-Breaker - паттерн для выявления отказа внешнего рассыльщика
* Retry - повторная отправка сообщения в случае недоступности рассыльщика

Circuit-Breaker и Retry объедены в одну логическую единицу (SSB)

В случае недоступности внешнего рассыльщика, CircuitBreaker извещает о этом сервис шаблонизации, который выбрасывает событие о недоступности в reply-bus. 

Далее, сервис Smart Sender по достижению критического кол-ва сообщений  останавливает продюсирование в Kafka, но сохраняет локально данные о письмах для шаблонизации.

### Схема решения
![](https://github.com/masterofgears/sysd2/blob/main/welltory.png)

### Диаграмма последовательности главного процесса
![](https://github.com/masterofgears/sysd2/blob/main/welltory-main-seq.png)

### Outstuff
Решение прредполагало некую работу аналитика, а не архитекора



